<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰¹é‡å¯¼å…¥é‚®ç®±è´¦å·</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .import-container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 30px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .step-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .step-tab {
      padding: 12px 24px;
      border: none;
      background: transparent;
      color: #666;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }
    
    .step-tab.active {
      color: #007bff;
      border-bottom-color: #007bff;
      font-weight: bold;
    }
    
    .step-content {
      display: none;
    }
    
    .step-content.active {
      display: block;
    }
    
    .format-guide {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .format-example {
      background: #fff;
      padding: 15px;
      border-left: 4px solid #007bff;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      overflow-x: auto;
    }
    
    .import-textarea {
      width: 100%;
      min-height: 200px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      resize: vertical;
    }
    
    .import-textarea:focus {
      outline: none;
      border-color: #007bff;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #007bff;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0056b3;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #545b62;
    }
    
    .accounts-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .accounts-table th,
    .accounts-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    .accounts-table th {
      background: #f8f9fa;
      font-weight: bold;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .status-valid {
      background: #d4edda;
      color: #155724;
    }
    
    .status-invalid {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #f0f0f0;
      border-radius: 15px;
      overflow: hidden;
      margin: 20px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .file-drop-zone {
      border: 3px dashed #ccc;
      border-radius: 12px;
      padding: 60px 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 20px;
    }
    
    .file-drop-zone:hover,
    .file-drop-zone.drag-over {
      border-color: #007bff;
      background: #f0f8ff;
    }
    
    .file-drop-zone input[type="file"] {
      display: none;
    }
    
    .log-console {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }
    
    .log-entry {
      margin: 3px 0;
      padding: 2px 0;
    }
    
    .log-info { color: #4fc3f7; }
    .log-success { color: #81c784; }
    .log-error { color: #e57373; }
    .log-warning { color: #ffb74d; }
  </style>
</head>
<body>
  
  <div class="import-container">
    <h1 style="margin-bottom: 30px;">ğŸ“¥ æ‰¹é‡å¯¼å…¥é‚®ç®±è´¦å·</h1>
    
    <div class="step-tabs">
      <button class="step-tab active" data-step="input">1. è¾“å…¥è´¦å·</button>
      <button class="step-tab" data-step="parse">2. è§£æéªŒè¯</button>
      <button class="step-tab" data-step="validate">3. æ‰¹é‡éªŒè¯</button>
      <button class="step-tab" data-step="save">4. ä¿å­˜å…¥åº“</button>
    </div>
    
    <!-- Step 1: Input -->
    <div class="step-content active" id="step-input">
      <div class="format-guide">
        <h3>ğŸ“‹ æ”¯æŒçš„æ ¼å¼</h3>
        <p>æ”¯æŒä»¥ä¸‹å‡ ç§æ ¼å¼å¯¼å…¥è´¦å·ï¼š</p>
        
        <div class="format-example">
          <strong>æ ¼å¼1ï¼šå†’å·åˆ†éš”</strong><br>
          example1@outlook.com:Password123<br>
          example2@hotmail.com:Password456
        </div>
        
        <div class="format-example">
          <strong>æ ¼å¼2ï¼šå››æ¨ªçº¿åˆ†éš”</strong><br>
          example1@outlook.com----Password123<br>
          example2@hotmail.com----Password456
        </div>
        
        <div class="format-example">
          <strong>æ ¼å¼3ï¼šç«–çº¿åˆ†éš”</strong><br>
          example1@outlook.com|Password123<br>
          example2@hotmail.com|Password456
        </div>
        
        <div class="format-example">
          <strong>æ ¼å¼4ï¼šCSVæ ¼å¼</strong><br>
          email,password<br>
          example1@outlook.com,Password123<br>
          example2@hotmail.com,Password456
        </div>
        
        <div class="format-example">
          <strong>æ ¼å¼5ï¼šJSONæ ¼å¼</strong><br>
          [<br>
          &nbsp;&nbsp;{"email":"example1@outlook.com","password":"Password123"},<br>
          &nbsp;&nbsp;{"email":"example2@hotmail.com","password":"Password456"}<br>
          ]
        </div>
      </div>
      
      <div class="file-drop-zone" id="dropZone">
        <input type="file" id="fileInput" accept=".txt,.csv,.json">
        <h3>ğŸ“ æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</h3>
        <p>æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ (æ”¯æŒ .txt, .csv, .json)</p>
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
      </div>
      
      <h3>æˆ–ç›´æ¥ç²˜è´´è´¦å·æ•°æ®ï¼š</h3>
      <textarea id="accountsInput" class="import-textarea" placeholder="ç²˜è´´è´¦å·æ•°æ®åˆ°è¿™é‡Œ..."></textarea>
      
      <div class="button-group">
        <button class="btn btn-primary" onclick="parseAccounts()">è§£æè´¦å·</button>
        <button class="btn btn-secondary" onclick="clearInput()">æ¸…ç©º</button>
      </div>
    </div>
    
    <!-- Step 2: Parse -->
    <div class="step-content" id="step-parse">
      <h3>å·²è§£æè´¦å·åˆ—è¡¨</h3>
      <div id="parsedStats" style="margin: 15px 0;"></div>
      
      <table class="accounts-table" id="parsedTable">
        <thead>
          <tr>
            <th>åºå·</th>
            <th>é‚®ç®±</th>
            <th>å¯†ç </th>
            <th>çŠ¶æ€</th>
          </tr>
        </thead>
        <tbody id="parsedTableBody">
        </tbody>
      </table>
      
      <div class="button-group">
        <button class="btn btn-primary" onclick="startValidation()">å¼€å§‹éªŒè¯</button>
        <button class="btn btn-secondary" onclick="backToInput()">è¿”å›ä¿®æ”¹</button>
      </div>
    </div>
    
    <!-- Step 3: Validate -->
    <div class="step-content" id="step-validate">
      <h3>æ‰¹é‡éªŒè¯è´¦å·</h3>
      
      <div>
        <label>ClientID: <input type="text" id="clientId" style="width: 500px; padding: 8px;" placeholder="è¾“å…¥Microsoft App ClientID"></label>
      </div>
      
      <div style="margin: 15px 0;">
        <label>å¹¶å‘æ•°: <input type="number" id="concurrency" min="1" max="10" value="3" style="width: 100px; padding: 8px;"></label>
        <span style="margin-left: 10px; color: #666;">å»ºè®®1-3ï¼Œé¿å…è§¦å‘é¢‘ç‡é™åˆ¶</span>
      </div>
      
      <div class="progress-bar" id="validateProgress" style="display: none;">
        <div class="progress-fill" id="validateProgressFill">0%</div>
      </div>
      
      <div class="log-console" id="validateLog"></div>
      
      <table class="accounts-table" id="validateTable" style="margin-top: 20px;">
        <thead>
          <tr>
            <th>é‚®ç®±</th>
            <th>éªŒè¯çŠ¶æ€</th>
            <th>è¯¦æƒ…</th>
          </tr>
        </thead>
        <tbody id="validateTableBody">
        </tbody>
      </table>
      
      <div class="button-group">
        <button class="btn btn-primary" id="validateBtn" onclick="runValidation()">å¼€å§‹éªŒè¯</button>
        <button class="btn btn-primary" id="saveBtn" onclick="saveToDatabase()" style="display: none;">ä¿å­˜åˆ°æ•°æ®åº“</button>
        <button class="btn btn-secondary" onclick="backToParse()">è¿”å›</button>
      </div>
    </div>
    
    <!-- Step 4: Save -->
    <div class="step-content" id="step-save">
      <h3>âœ… ä¿å­˜å®Œæˆ</h3>
      
      <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h2 style="color: #155724; margin-top: 0;">ğŸ‰ å¯¼å…¥æˆåŠŸï¼</h2>
        <div id="saveStats"></div>
      </div>
      
      <div class="button-group">
        <button class="btn btn-primary" onclick="window.location.href='index.html'">è¿”å›é¦–é¡µ</button>
        <button class="btn btn-secondary" onclick="resetImport()">ç»§ç»­å¯¼å…¥</button>
      </div>
    </div>
  </div>
  
  <script>
    let parsedAccounts = [];
    let validatedAccounts = [];
    
    // Tabåˆ‡æ¢
    document.querySelectorAll('.step-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const step = tab.dataset.step;
        switchToStep(step);
      });
    });
    
    function switchToStep(step) {
      document.querySelectorAll('.step-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.step-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`[data-step="${step}"]`).classList.add('active');
      document.getElementById(`step-${step}`).classList.add('active');
    }
    
    // æ–‡ä»¶æ‹–æ‹½
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });
    
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });
    
    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('accountsInput').value = e.target.result;
      };
      reader.readAsText(file);
    }
    
    // è§£æè´¦å·
    function parseAccounts() {
      const text = document.getElementById('accountsInput').value.trim();
      if (!text) {
        alert('è¯·è¾“å…¥è´¦å·æ•°æ®');
        return;
      }
      
      try {
        parsedAccounts = window.accountImporterAPI.parseFromText(text, 'auto');
        
        if (parsedAccounts.length === 0) {
          alert('æœªèƒ½è§£æå‡ºä»»ä½•è´¦å·ï¼Œè¯·æ£€æŸ¥æ ¼å¼');
          return;
        }
        
        displayParsedAccounts();
        switchToStep('parse');
      } catch (error) {
        alert('è§£æå¤±è´¥: ' + error.message);
      }
    }
    
    function displayParsedAccounts() {
      const tbody = document.getElementById('parsedTableBody');
      tbody.innerHTML = '';
      
      parsedAccounts.forEach((account, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${account.email}</td>
          <td>${'*'.repeat(account.password.length)}</td>
          <td><span class="status-badge status-pending">å¾…éªŒè¯</span></td>
        `;
      });
      
      document.getElementById('parsedStats').innerHTML = `
        <strong>å…±è§£æ ${parsedAccounts.length} ä¸ªè´¦å·</strong>
      `;
    }
    
    function clearInput() {
      document.getElementById('accountsInput').value = '';
      document.getElementById('fileInput').value = '';
    }
    
    function backToInput() {
      switchToStep('input');
    }
    
    function startValidation() {
      switchToStep('validate');
      
      const tbody = document.getElementById('validateTableBody');
      tbody.innerHTML = '';
      
      parsedAccounts.forEach(account => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${account.email}</td>
          <td><span class="status-badge status-pending">ç­‰å¾…ä¸­</span></td>
          <td>-</td>
        `;
      });
    }
    
    function backToParse() {
      switchToStep('parse');
    }
    
    // è¿è¡ŒéªŒè¯
    async function runValidation() {
      const clientId = document.getElementById('clientId').value.trim();
      if (!clientId) {
        alert('è¯·è¾“å…¥ClientID');
        return;
      }
      
      const concurrency = parseInt(document.getElementById('concurrency').value) || 3;
      
      document.getElementById('validateBtn').disabled = true;
      document.getElementById('validateProgress').style.display = 'block';
      
      const logDiv = document.getElementById('validateLog');
      logDiv.innerHTML = '';
      
      function addLog(type, message) {
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
      }
      
      try {
        validatedAccounts = await window.accountImporterAPI.batchValidate(
          parsedAccounts,
          clientId,
          concurrency,
          (progress) => {
            if (progress.type === 'progress') {
              const percent = Math.round(progress.current / progress.total * 100);
              document.getElementById('validateProgressFill').style.width = percent + '%';
              document.getElementById('validateProgressFill').textContent = `${progress.current}/${progress.total} (${percent}%)`;
            } else {
              addLog(progress.type, progress.message);
              
              // æ›´æ–°è¡¨æ ¼
              const tbody = document.getElementById('validateTableBody');
              const rows = tbody.querySelectorAll('tr');
              
              parsedAccounts.forEach((account, index) => {
                if (progress.message.includes(account.email)) {
                  const statusCell = rows[index].cells[1];
                  const detailCell = rows[index].cells[2];
                  
                  if (progress.type === 'success') {
                    statusCell.innerHTML = '<span class="status-badge status-valid">âœ“ æœ‰æ•ˆ</span>';
                    detailCell.textContent = 'éªŒè¯æˆåŠŸ';
                  } else if (progress.type === 'error') {
                    statusCell.innerHTML = '<span class="status-badge status-invalid">âœ— æ— æ•ˆ</span>';
                    detailCell.textContent = progress.message.split(':')[1] || 'éªŒè¯å¤±è´¥';
                  }
                }
              });
            }
          }
        );
        
        addLog('success', `âœ… éªŒè¯å®Œæˆï¼æœ‰æ•ˆè´¦å·: ${validatedAccounts.filter(a => a.valid).length}/${validatedAccounts.length}`);
        
        document.getElementById('saveBtn').style.display = 'inline-block';
        
      } catch (error) {
        addLog('error', 'éªŒè¯è¿‡ç¨‹å‡ºé”™: ' + error.message);
        alert('éªŒè¯å¤±è´¥: ' + error.message);
      } finally {
        document.getElementById('validateBtn').disabled = false;
      }
    }
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    async function saveToDatabase() {
      try {
        await window.emailDatabaseAPI.init();
        
        const validAccounts = validatedAccounts.filter(a => a.valid);
        
        for (const account of validAccounts) {
          await window.emailDatabaseAPI.saveAccount({
            email: account.email,
            password: account.password,
            refresh_token: account.refreshToken,
            access_token: account.accessToken,
            is_authorized: 1,
            is_used: 0
          });
        }
        
        document.getElementById('saveStats').innerHTML = `
          <p style="font-size: 18px;">âœ… æˆåŠŸä¿å­˜ <strong>${validAccounts.length}</strong> ä¸ªæœ‰æ•ˆè´¦å·åˆ°æ•°æ®åº“</p>
          <p>âŒ æ— æ•ˆè´¦å·: <strong>${validatedAccounts.length - validAccounts.length}</strong> ä¸ª</p>
        `;
        
        switchToStep('save');
        
      } catch (error) {
        alert('ä¿å­˜å¤±è´¥: ' + error.message);
      }
    }
    
    function resetImport() {
      parsedAccounts = [];
      validatedAccounts = [];
      document.getElementById('accountsInput').value = '';
      document.getElementById('fileInput').value = '';
      switchToStep('input');
    }
    
    // åˆå§‹åŒ–æ•°æ®åº“
    window.emailDatabaseAPI.init().catch(err => {
      console.error('Database init failed:', err);
    });
  </script>
</body>
</html>
